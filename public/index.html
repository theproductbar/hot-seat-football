<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Endzone Madness</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }

    body{
      width:100vw;
      min-height:100svh;
      display:flex;
      justify-content:center;
      align-items:center;
      background:#000;
      overflow:hidden;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    .stage{
      position:relative;
      width:100vw;
      height:100svh;
      display:flex;
      justify-content:center;
      align-items:center;
      background:#000;
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* =========================
       ✅ TOP BAR (NO OVERLAP)
       Left = Superbowl toggle
       Center = Title
       Right = Admin
       ========================= */
    .topBar{
      position:absolute;
      top: calc(14px + env(safe-area-inset-top));
      left: 0;
      right: 0;
      z-index: 110;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      padding:
        0 calc(14px + env(safe-area-inset-right))
        0 calc(14px + env(safe-area-inset-left));
      pointer-events: none; /* only pills/buttons clickable */
    }

    .topTitle{
      pointer-events: none;
      justify-self: center;
      font-weight: 900;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      font-size: 14px;
      padding: 10px 18px;
      border-radius: 999px;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      white-space: nowrap;
    }

    /* Left pill: Superbowl toggle */
    .sbPill{
      justify-self: start;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.55);
      pointer-events: auto;
      user-select: none;
    }

    .sbLabel{
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
    }

    .sbSwitch{
      position: relative;
      width: 46px;
      height: 26px;
      border-radius: 999px;
      background: rgba(255,255,255,0.20);
      border: 1px solid rgba(255,255,255,0.18);
      cursor: pointer;
      flex: 0 0 auto;
    }
    .sbKnob{
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      transition: transform 160ms ease;
    }
    .sbSwitch.on{
      background: rgba(250,204,21,0.35);
      border-color: rgba(250,204,21,0.40);
    }
    .sbSwitch.on .sbKnob{
      transform: translateX(20px);
    }

    /* Right: Admin */
    .adminLink{
      justify-self: end;
      pointer-events: auto;
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.55);
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      user-select: none;
      white-space: nowrap;
    }
    .adminLink:hover{ background: rgba(0,0,0,0.6); }
    .adminLink:active{ transform: translateY(1px); }

    #image{
      max-width:100vw;
      max-height:100vh;
      object-fit:contain;
      display:none;
      z-index:5;
      border-radius:14px;
      box-shadow:0 22px 60px rgba(0,0,0,0.8);
    }

    .veil{
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 50% 35%, rgba(255,255,255,0.06), rgba(0,0,0,0.92) 55%, rgba(0,0,0,0.98) 100%);
      pointer-events:none;
      z-index:6;
    }

    .spinLabel{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      font-weight:900;
      letter-spacing:0.18em;
      text-transform:uppercase;
      font-size:14px;
      padding:18px 26px;
      border-radius:999px;
      background:rgba(0,0,0,0.72);
      backdrop-filter:blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,0.65);
      z-index:50;
      display:none;
      animation:pulse 0.7s ease-in-out infinite;
      white-space:nowrap;
      pointer-events:none;
    }

    @keyframes pulse{
      0%{opacity:.7;transform:translate(-50%,-50%) scale(1);}
      50%{opacity:1;transform:translate(-50%,-50%) scale(1.12);}
      100%{opacity:.7;transform:translate(-50%,-50%) scale(1);}
    }

    .bottomPill{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(92px + env(safe-area-inset-bottom));
      z-index:80;
      background:rgba(0,0,0,0.75);
      backdrop-filter:blur(10px);
      padding:12px 14px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:0.10em;
      text-transform:uppercase;
      box-shadow:0 18px 60px rgba(0,0,0,0.7);
      width:min(94vw,720px);
      text-align:center;
      line-height:1.2;
      white-space:normal;
      overflow-wrap:anywhere;
    }

    .gold{ color:#facc15; }

    .controls{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(14px + env(safe-area-inset-bottom));
      display:flex;
      gap:10px;
      z-index:90;
      width:min(94vw,520px);
      justify-content:center;
      flex-wrap:wrap;
    }

    button{
      border:none;
      cursor:pointer;
      border-radius:999px;
      background:rgba(255,255,255,0.18);
      color:#fff;
      backdrop-filter:blur(10px);
      box-shadow:0 18px 60px rgba(0,0,0,0.7);
      flex:1 1 160px;
      min-width:140px;
      max-width:260px;
      padding:16px;
      font-weight:900;
      letter-spacing:0.10em;
      text-transform:uppercase;
      font-size:13px;
    }

    .disabled{ opacity:.35; pointer-events:none; }

    /* ===== Touchdown Flash #1 (color) — LONGER ===== */
    .flash{
      position:absolute;
      inset:0;
      z-index:120;
      opacity:0;
      background:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.9), rgba(255,255,255,0) 55%),
        linear-gradient(90deg, rgba(250,204,21,.45), rgba(168,85,247,.35), rgba(59,130,246,.35));
      mix-blend-mode:screen;
      pointer-events:none;
    }
    .flash.play{ animation:flashAnim 2200ms ease-out 1; }
    @keyframes flashAnim{
      0%{opacity:0}
      10%{opacity:1}
      35%{opacity:.85}
      70%{opacity:.55}
      100%{opacity:0}
    }

    /* ===== Touchdown Flash #2 (white strobe) — LONGER ===== */
    #tdFlash{
      position:fixed;
      inset:0;
      background:white;
      opacity:0;
      pointer-events:none;
      z-index:9999;
    }
    #tdFlash.flash{ animation:tdFlashAnim 2200ms ease-in-out 1; }
    @keyframes tdFlashAnim{
      0%{opacity:0}
      10%{opacity:.95}
      18%{opacity:.08}
      28%{opacity:.95}
      40%{opacity:.12}
      52%{opacity:.95}
      65%{opacity:.12}
      78%{opacity:.85}
      100%{opacity:0}
    }
  </style>
</head>

<body>
  <div class="stage">

    <!-- ✅ NEW TOP BAR (SB toggle + title + admin) -->
    <div class="topBar">
      <div class="sbPill" id="sbPill">
        <div class="sbLabel">Superbowl</div>
        <div class="sbSwitch" id="sbSwitch" role="switch" aria-checked="false">
          <div class="sbKnob"></div>
        </div>
      </div>

      <div class="topTitle">Endzone Madness</div>

      <a class="adminLink" href="/admin.html">ADMIN</a>
    </div>

    <img id="image" alt="">
    <div class="veil"></div>

    <div class="spinLabel" id="spinLabel">SPINNING…</div>

    <div class="bottomPill" id="bottomPill">
      PRESS <span class="gold">QB PASS</span> OR <span class="gold">RECEIVER</span>
    </div>

    <div class="controls">
      <button id="btnQB">QB PASS</button>
      <button id="btnReceiver">RECEIVER</button>
    </div>

    <div class="flash" id="flash"></div>
  </div>

  <div id="tdFlash"></div>

  <!-- ✅ Crowd sound -->
  <audio id="tdAudio" preload="auto" src="/sounds/td-crowd.mp3"></audio>

  <script>
    const SPIN_SPEED_MS = 90;
    const QB_SPIN_MS = 5400;
    const RECEIVER_SPIN_MS = 5400;
    const TD_FLASH_MS = 2200;

    const img = document.getElementById("image");
    const spinLabel = document.getElementById("spinLabel");
    const bottomPill = document.getElementById("bottomPill");
    const flash = document.getElementById("flash");
    const tdFlash = document.getElementById("tdFlash");
    const tdAudio = document.getElementById("tdAudio");

    const btnQB = document.getElementById("btnQB");
    const btnReceiver = document.getElementById("btnReceiver");

    // ===== SB MODE toggle (localStorage) =====
    const sbSwitch = document.getElementById("sbSwitch");
    const SB_KEY = "SB_MODE";

    function isSB(){
      return localStorage.getItem(SB_KEY) === "1";
    }
    function setSB(on){
      localStorage.setItem(SB_KEY, on ? "1" : "0");
      sbSwitch.classList.toggle("on", on);
      sbSwitch.setAttribute("aria-checked", on ? "true" : "false");
    }
    setSB(isSB());
    sbSwitch.addEventListener("click", () => setSB(!isSB()));

    let spinning = false, spinInterval = null;

    async function fetchJSON(url){
      const sep = url.includes("?") ? "&" : "?";
      const r = await fetch(url + sep + "t=" + Date.now());
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function setButtonsDisabled(d){
      btnQB.classList.toggle("disabled", d);
      btnReceiver.classList.toggle("disabled", d);
    }

    // ✅ Unlock audio WITHOUT sound
    let audioUnlocked = false;
    function unlockAudioOnce(){
      if (audioUnlocked) return;
      audioUnlocked = true;

      try{
        tdAudio.volume = 0;
        tdAudio.muted = true;

        const p = tdAudio.play();
        if (p && p.then){
          p.then(()=>{
            tdAudio.pause();
            tdAudio.currentTime = 0;
          }).catch(()=>{});
        } else {
          tdAudio.pause();
          tdAudio.currentTime = 0;
        }
      }catch{}
    }
    document.addEventListener("touchstart", unlockAudioOnce, { once:true });
    document.addEventListener("click", unlockAudioOnce, { once:true });

    function playTDCrowd(){
      try{
        tdAudio.pause();
        tdAudio.currentTime = 0;

        tdAudio.muted = false;
        tdAudio.volume = 1;

        const p = tdAudio.play();
        if (p && p.catch) p.catch(()=>{});
      }catch{}

      setTimeout(()=>{
        try{
          tdAudio.pause();
          tdAudio.currentTime = 0;
          tdAudio.muted = true;
          tdAudio.volume = 0;
        }catch{}
      }, TD_FLASH_MS);
    }

    function playTD(){
      flash.classList.remove("play");
      tdFlash.classList.remove("flash");
      void flash.offsetWidth;
      void tdFlash.offsetWidth;
      flash.classList.add("play");
      tdFlash.classList.add("flash");
      playTDCrowd();
    }

    async function spin(type){
      if(spinning) return;
      spinning = true;
      setButtonsDisabled(true);

      unlockAudioOnce();

      img.style.display = "block";
      spinLabel.textContent = type==="QB" ? "QB PASSING…" : "CATCHING…";
      spinLabel.style.display = "block";

      bottomPill.style.visibility = "hidden";

      const duration = type==="QB" ? QB_SPIN_MS : RECEIVER_SPIN_MS;

      spinInterval = setInterval(async()=>{
        try{
          const d = await fetchJSON(`/api/random-image?type=${encodeURIComponent(type)}`);
          img.src = d.url;
        }catch{}
      }, SPIN_SPEED_MS);

      setTimeout(async()=>{
        clearInterval(spinInterval);

        try{
          const d = await fetchJSON(`/api/random-image?type=${encodeURIComponent(type)}`);
          img.src = d.url;

          if(type==="QB"){
            const p = await fetchJSON("/api/random-player");
            bottomPill.innerHTML = `PASS TO: <span class="gold">${p.name}</span>`;
          }else{
            const mode = isSB() ? "sb" : "normal";
            const c = await fetchJSON(`/api/random-catch?mode=${mode}`);
            bottomPill.innerHTML = `CATCH: <span class="gold">${c.catch}</span>`;
            if(String(c.catch).toUpperCase().includes("TOUCHDOWN")) playTD();
          }
        }catch{
          bottomPill.innerHTML = "<span class='gold'>ERROR</span>";
        }

        bottomPill.style.visibility = "visible";

        spinLabel.style.display = "none";
        spinning = false;
        setButtonsDisabled(false);
      }, duration);
    }

    btnQB.onclick = () => spin("QB");
    btnReceiver.onclick = () => spin("Receiver");

    // Initial image on load
    (async()=>{
      try{
        const d = await fetchJSON("/api/random-image?type=QB");
        img.src = d.url;
        img.style.display = "block";
      }catch{}
    })();
  </script>
</body>
</html>