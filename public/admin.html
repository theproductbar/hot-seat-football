<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Receiver Players Admin</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      min-height:100svh;
      display:flex;
      justify-content:center;
      align-items:center;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      overflow:hidden;
    }

    .wrap{
      width:min(1100px, 94vw);
      margin:0 auto;
      padding:28px;
      border-radius:28px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 30px 120px rgba(0,0,0,.75);
      position:relative;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      margin-bottom:18px;
    }

    h1{
      font-size:38px;
      letter-spacing:.20em;
      text-transform:uppercase;
      font-weight:900;
      line-height:1.05;
    }

    .sub{
      margin-top:10px;
      color:rgba(255,255,255,0.75);
      font-size:18px;
      line-height:1.25;
    }

    .back{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:10px 16px;
      background:rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-weight:900;
      font-size:12px;
      box-shadow:0 12px 40px rgba(0,0,0,0.5);
      user-select:none;
    }

    .rowTop{
      display:flex;
      gap:16px;
      align-items:center;
      margin-top:18px;
      margin-bottom:10px;
    }

    input{
      flex:1;
      height:66px;
      padding:0 22px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.35);
      color:#fff;
      font-size:22px;
      outline:none;
    }
    input::placeholder{ color:rgba(255,255,255,0.35); }

    .btn{
      height:66px;
      padding:0 28px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.16em;
      font-size:15px;
      box-shadow:0 22px 60px rgba(0,0,0,0.7);
      user-select:none;
      white-space:nowrap;
    }

    .btnAdd{
      background:#facc15;
      color:#111;
    }

    .btnRefresh{
      background:rgba(255,255,255,0.18);
      color:#fff;
      border:1px solid rgba(255,255,255,0.10);
    }

    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    #msg{
      margin:14px 0 12px;
      min-height:22px;
      font-size:16px;
      color:#9cff9c;
    }

    .divider{
      height:1px;
      background:rgba(255,255,255,0.10);
      margin:16px 0;
    }

    #playersList{
      display:flex;
      flex-direction:column;
      gap:0;
      max-height:min(62svh, 560px);
      overflow:auto;
      padding-right:6px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:18px 4px;
      border-bottom:1px solid rgba(255,255,255,0.10);
    }

    .name{
      font-size:30px;
      font-weight:900;
      color:rgba(255,255,255,0.95);
    }

    .del{
      width:54px;
      height:54px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.35);
      color:#fff;
      font-size:28px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(0,0,0,0.45);
      user-select:none;
      flex:0 0 auto;
    }
    .del:disabled{opacity:.5;cursor:not-allowed;}

    .hint{
      margin-top:12px;
      color:rgba(255,255,255,0.55);
      font-size:13px;
      letter-spacing:.04em;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Receiver Players Admin</h1>
        <div class="sub">Add/remove players before the game. (Updates Google Sheet.)</div>
      </div>
      <button class="back" onclick="location.href='/'">Back</button>
    </div>

    <div class="rowTop">
      <input id="playerInput" placeholder="Add player name..." autocomplete="off" />
      <button id="addBtn" class="btn btnAdd">Add</button>
      <button id="refreshBtn" class="btn btnRefresh">Refresh</button>
    </div>

    <div id="msg"></div>

    <div class="divider"></div>

    <div id="playersList"></div>

    <div class="hint">Tip: If multiple people are editing at once, press Refresh to sync instantly.</div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const input = $("playerInput");
    const addBtn = $("addBtn");
    const refreshBtn = $("refreshBtn");
    const list = $("playersList");
    const msg = $("msg");

    function setMsg(text, isError=false){
      msg.textContent = text || "";
      msg.style.color = isError ? "#ff5a5a" : "#9cff9c";
    }

    async function api(path, opts){
      const r = await fetch(path, opts);
      const text = await r.text();

      let data;
      try { data = JSON.parse(text); }
      catch {
        // If server ever returns HTML, show it plainly
        throw new Error(text || "Bad response");
      }

      if(!r.ok) throw new Error(data.error || data.details || "Request failed");
      return data;
    }

    function render(players){
      list.innerHTML = "";

      (players || []).forEach((name) => {
        const row = document.createElement("div");
        row.className = "row";

        const label = document.createElement("div");
        label.className = "name";
        label.textContent = name;

        const del = document.createElement("button");
        del.className = "del";
        del.textContent = "×";

        del.onclick = async () => {
          try{
            del.disabled = true;
            setMsg("");

            await api("/api/admin/receiver-players", {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name })
            });

            // ✅ SAFE: always reload from server so UI never drifts
            await load();

          }catch(e){
            setMsg("Error: " + e.message, true);
          }finally{
            del.disabled = false;
          }
        };

        row.appendChild(label);
        row.appendChild(del);
        list.appendChild(row);
      });
    }

    async function load(){
      try{
        setMsg("");
        const data = await api("/api/admin/receiver-players");
        render(data.players || []);
      }catch(e){
        setMsg("Load failed: " + e.message, true);
      }
    }

    addBtn.onclick = async () => {
      const name = (input.value || "").trim();
      if(!name) return setMsg("Error: Missing name", true);

      try{
        addBtn.disabled = true;
        setMsg("");

        await api("/api/admin/receiver-players", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        });

        input.value = "";

        // ✅ SAFE: always reload from server so you see the final sheet state
        await load();

      }catch(e){
        setMsg("Error: " + e.message, true);
      }finally{
        addBtn.disabled = false;
      }
    };

    refreshBtn.onclick = load;

    // Enter key adds too (nice UX, still safe)
    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter") addBtn.click();
    });

    load();
  </script>
</body>
</html>